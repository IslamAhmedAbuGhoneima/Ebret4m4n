<section class="font-arabic h-screen flex flex-row-reverse">
  <aside
    *ngIf="role == 'doctor'"
    class="w-[300px] bg-white border border-r-third-border pt-6"
  >
    <h4 class="text-[28px] font-semibold text-center">Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª</h4>
    <ul class="mt-6">
      <li *ngFor="let item of userChatList">
        <a
          [routerLink]="['/chat', item.senderId]"
          routerLinkActive="bg-[#B6D4CA]"
          class="flex justify-between items-center pr-6 pl-4 py-3 hover:bg-third-bg"
        >
          <div class="flex gap-4">
            <div>
              <h6 class="text-semibold text-xl text-[#151419]">
                {{ item.firstName }} {{ item.lastName }}
              </h6>
              <span class="font-normal text-sm">
                {{ item.message.split(" ").slice(0, 1).join(" ") }}
              </span>
            </div>
          </div>
          <small
            class="block bg-[#099250] text-white rounded-full w-7 h-7 text-center leading-7 text-sm"
          >
            {{ item.message.length }}
          </small>
        </a>
      </li>
    </ul>
  </aside>

  <div
    *ngIf="selectedUserId || role === 'parent'; else showChatImage"
    class="content flex flex-col bg-[#F9FAFB]"
    [ngClass]="{ 'flex-1': role === 'doctor', 'w-full': role == 'parent' }"
  >
    <h6
      class="font-bold mb-2 text-lg text-[#151419] w-full px-6 py-4 bg-white border border-b-third-border"
    >
      {{ role == "parent" ? "Ø¯/ " + user : user }}
    </h6>

    <div class="flex-1 overflow-y-auto content-end scroll-container p-2">
      <ul class="relative flex flex-col gap-1 mb-40 text-right">
        @for (msg of messages; track $index) { @if (msg.File) {
        <li
          [ngClass]="{
            'ml-auto bg-primary-bg text-white ': msg.senderId === senderId,
            'mr-auto text-black bg-[#EAEDEB]': msg.senderId !== senderId
          }"
          class="max-w-[60%] font-normal rounded-md px-3 py-2 relative shadow-md break-words"
        >
          <div
            class="flex items-end gap-1 relative"
            [ngClass]="{
              'flex-row-reverse': msg.senderId === senderId,
              'flex-row': msg.senderId !== senderId,
            }"
          >
            {{ msg.File.type }}
            <ng-container [ngSwitch]="msg.File.type">
              <img
                *ngSwitchCase="'image'"
                [src]="msg.File.preview"
                alt="ØµÙˆØ±Ø©"
                class="w-20 h-20 object-cover rounded-md"
              />
              <div *ngSwitchCase="'file'" class="flex items-center gap-2">
                <span class="text-xl">ðŸ“„</span>
                <span class="truncate w-40">{{ msg.File.name }}</span>
              </div>
            </ng-container>
            <!-- 
            <button class="">
              <img [src]="msg.File" alt="sent image" class="object-cover" />
            </button> -->
            <small
              class="text-[10px] whitespace-nowrap absolute right-1 bottom-1"
            >
              {{ formatTime(msg.sentAt) }}
            </small>
          </div>

          <img
            *ngIf="isLastMessageOfSender($index) && msg.senderId == senderId"
            src="/icons/Union-green.svg"
            alt=""
            class="absolute -right-[10px] bottom-0"
          />
          <img
            *ngIf="isLastMessageOfSender($index) && msg.senderId !== senderId"
            src="/icons/Unio-gray.svg"
            alt=""
            class="absolute -left-[10px] bottom-0"
          />
        </li>
        } @else{
        <li
          [ngClass]="{
            'ml-auto bg-primary-bg text-white ': msg.senderId === senderId,
            'mr-auto text-black bg-[#EAEDEB]': msg.senderId !== senderId
          }"
          class="max-w-[60%] font-normal rounded-2xl px-4 py-2 relative shadow-md break-words"
        >
          <div
            class="flex items-end gap-1"
            [ngClass]="{
              'flex-row-reverse': msg.senderId === senderId,
              'flex-row': msg.senderId !== senderId,
            }"
          >
            <p
              class="flex-1 text-right text-sm font-semibold break-words break-all whitespace-pre-wrap"
            >
              {{ msg.message }}
            </p>

            <small class="text-[10px] whitespace-nowrap">
              {{ formatTime(msg.sentAt) }}
            </small>
          </div>

          <img
            *ngIf="isLastMessageOfSender($index) && msg.senderId == senderId"
            src="/icons/Union-green.svg"
            alt=""
            class="absolute -right-[10px] bottom-0"
          />
          <img
            *ngIf="isLastMessageOfSender($index) && msg.senderId !== senderId"
            src="/icons/Unio-gray.svg"
            alt=""
            class="absolute -left-[10px] bottom-0"
          />
        </li>
        }}
      </ul>
    </div>

    <div
      class="flex items-center gap-3 px-6 h-16 bg-white border border-t-third-border"
    >
      <button (click)="sendMessage()">
        <img src="/icons/Send.svg" alt="" />
      </button>
      <textarea
        #messageInput
        [(ngModel)]="newMessage"
        (keydown.enter)="onEnter($event)"
        placeholder="Ø£ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©"
        class="flex-1 placeholder:text-third-txt resize-none overflow-hidden scroll-container"
        rows="1"
      ></textarea>

      <div>
        <label for="files" class="cursor-pointer">
          <img src="/icons/Outline.svg" alt="" />
        </label>
        <input
          type="file"
          name="files"
          id="files"
          class="hidden"
          (change)="getPath($event)"
          (change)="sendFile($event)"
        />
      </div>
    </div>
  </div>

  <ng-template #showChatImage>
    <div
      *ngIf="role === 'doctor'"
      class="flex-1 h-full flex justify-center items-center"
    >
      <img src="/images/chat.svg" alt="chat image" />
    </div>
  </ng-template>
</section>
